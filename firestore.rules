rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to get user's festival ID
    function getUserFestivalId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.festivalId;
    }

    // Helper function to check if user belongs to the festival
    function belongsToFestival(festivalId) {
      return isSignedIn() && getUserFestivalId() == festivalId;
    }

    // Helper function to check if user is admin or owner
    function isAdminOrOwner(festivalId) {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      let festivalDoc = get(/databases/$(database)/documents/festivals/$(festivalId)).data;
      return isSignedIn() && (
        festivalDoc.ownerId == request.auth.uid ||
        (userDoc.festivalId == festivalId && userDoc.role == 'admin')
      );
    }

    // Users collection - Allow owners to query by email for invitations
    match /users/{userId} {
      allow read: if isSignedIn() && (
        request.auth.uid == userId ||
        getUserFestivalId() == resource.data.festivalId
      );
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && (
        request.auth.uid == userId ||
        (resource.data.festivalId == getUserFestivalId() &&
         get(/databases/$(database)/documents/festivals/$(resource.data.festivalId)).data.ownerId == request.auth.uid)
      );
      allow delete: if false;
      // Allow listing/querying users for invitation checks
      allow list: if isSignedIn();
    }

    // Invitations collection - Root level (for signup/invitation lookups)
    match /invitations/{invitationId} {
      allow read, write: if isSignedIn();
    }

    // Festivals collection
    match /festivals/{festivalId} {
      allow read: if isSignedIn() && (
        belongsToFestival(festivalId) ||
        resource.data.ownerId == request.auth.uid
      );
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (
        belongsToFestival(festivalId) ||
        resource.data.ownerId == request.auth.uid
      );
      allow delete: if isSignedIn() && resource.data.ownerId == request.auth.uid;

      // Gear subcollection - only accessible to festival members
      match /gear/{gearId} {
        allow read, write: if belongsToFestival(festivalId);
      }

      // Locations subcollection
      match /locations/{locationId} {
        allow read, write: if belongsToFestival(festivalId);
      }

      // Performances subcollection
      match /performances/{performanceId} {
        allow read, write: if belongsToFestival(festivalId);
      }

      // Scans subcollection
      match /scans/{scanId} {
        allow read, write: if belongsToFestival(festivalId);
      }

      // Messages subcollection - Admin/Owner can write, all can read
      match /messages/{messageId} {
        allow read: if belongsToFestival(festivalId);
        allow write: if isAdminOrOwner(festivalId);
      }

      // Message reads subcollection - Users can track their own read status
      match /message_reads/{readId} {
        allow read: if belongsToFestival(festivalId);
        allow create: if belongsToFestival(festivalId) && request.resource.data.user_id == request.auth.uid;
        allow delete: if belongsToFestival(festivalId);
      }

      // NEW: Bands collection
      match /bands/{bandId} {
        allow read: if belongsToFestival(festivalId);
        allow write: if belongsToFestival(festivalId);
      }

      // NEW: Reminders collection (user's personal reminders within festival context)
      match /reminders/{reminderId} {
        allow read: if belongsToFestival(festivalId) && resource.data.userId == request.auth.uid;
        allow create: if belongsToFestival(festivalId) && request.resource.data.userId == request.auth.uid;
        allow update: if belongsToFestival(festivalId) && resource.data.userId == request.auth.uid;
        allow delete: if belongsToFestival(festivalId) && resource.data.userId == request.auth.uid;
      }

      // Containers collection - Admin/Owner can write, all can read
      match /containers/{containerId} {
        allow read: if belongsToFestival(festivalId);
        allow write: if isAdminOrOwner(festivalId);
      }

      // Stowage items collection - Admin/Owner can write, all can read
      match /stowage_items/{stowageId} {
        allow read: if belongsToFestival(festivalId);
        allow write: if isAdminOrOwner(festivalId);
      }
    }
  }
}
